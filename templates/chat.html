{% extends "base.html" %}

{% block content %}
<h2>Chat Room {{ room_id }}</h2>

<small id="status" style="color: orange;">Connecting...</small>

<div id="messages"></div>

<input id="messageText" placeholder="Type message">
<button onclick="sendMessage()">Send</button>

<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");  // ✅ always ready, no async race
const roomId = "{{ room_id }}";

if (!token || !username) window.location.href = "/";

// Load old messages
function loadMessages() {
    fetch(`/api/chat/rooms/${roomId}/messages/`, {
        headers: {"Authorization": "Bearer " + token}
    })
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById("messages");
        box.innerHTML = "";
        data.forEach(msg => {
            box.innerHTML += `<p><b>${msg.sender.username}:</b> ${msg.content}</p>`;
        });
        box.scrollTop = box.scrollHeight;
    });
}

// WebSocket
const socket = new WebSocket("ws://" + window.location.host + "/ws/chat/" + roomId + "/");

socket.onopen = () => {
    document.getElementById("status").textContent = "Connected ✅";
    document.getElementById("status").style.color = "green";
    console.log("WebSocket connected");
};

socket.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const box = document.getElementById("messages");
    box.innerHTML += `<p><b>${data.username}:</b> ${data.message}</p>`;
    box.scrollTop = box.scrollHeight;
};

socket.onerror = (e) => {
    document.getElementById("status").textContent = "Connection error ❌";
    document.getElementById("status").style.color = "red";
    console.error("WebSocket error:", e);
};

socket.onclose = (e) => {
    document.getElementById("status").textContent = "Disconnected ❌ (code: " + e.code + ")";
    document.getElementById("status").style.color = "red";
    console.log("WebSocket closed:", e.code, e.reason);
};

function sendMessage() {
    const input = document.getElementById("messageText");
    const message = input.value.trim();

    if (!message) return;

    // ✅ Check socket is open before sending
    if (socket.readyState !== WebSocket.OPEN) {
        alert("Not connected. Please refresh the page.");
        return;
    }

    socket.send(JSON.stringify({
        message: message,
        username: username  // ✅ from localStorage, always has value
    }));

    input.value = "";
}

// Send on Enter key
document.getElementById("messageText").addEventListener("keypress", (e) => {
    if (e.key === "Enter") sendMessage();
});

loadMessages();
</script>
{% endblock %}